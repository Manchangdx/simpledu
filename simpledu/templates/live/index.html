{% extends 'base.html' %}

{% block title %}Live{% endblock %}

{% block css %}
  <style>
    #message-box {
      background-color: #eee;
      font-size: 15px;
      padding: 3px 0 0 5px;
      width: 100%;
      height: 455px;
      border-radius: 3px;
      margin-bottom: 10px;
      overflow: scroll;
    }
  </style>
{% endblock %}

{% block body %}
  <div class='row'>
    <div class='col-md-9'>
      <video id='videoElement' width='100%' height='500px' controls='controls'></video>
    </div>
    <div class='col-md-3'>
      <div id='message-box'>
      </div>
      <div class='input-group' id='message-form'>
        <input type='text' class='form-control'>
        <span class='input-group-btn'>
          <button class='btn btn-primary' type='button'>发言</button>
        </span>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flv.js/1.3.3/flv.min.js"></script>
  <script>
    if (flvjs.isSupported()) {
      var videoElement = document.getElementById('videoElement');
      var flvPlayer = flvjs.createPlayer({
        type: 'flv',
        isLive: true,
        // 直播地址
        url: 'https://cn-jsnt-dx-live-02.live-play.acgvideo.com/live-bvc/998416/live_20848957_7290944.flv?expires=1538227447&ssig=TzgSWnZrl6hQO32vYKu7fw&oi=2883570500'
      });
      flvPlayer.attachMediaElement(videoElement);
      flvPlayer.load();
      flvPlayer.play();
    }
  </script>
  <script>
    // 这是两个 WebSocket 连接
    // 定义接收消息的盒子，相当于接收消息的用户
    var inbox = new WebSocket('ws://'+location.host+'/ws/receive');
    // 定义发送消息的盒子，相当于发送消息的用户
    var outbox = new WebSocket('ws://'+location.host+"/ws/send");

    // 为 inbox 和 outbox 绑定 onclose 事件，当 WebSocket 断开后，自动重连
    inbox.onclose = function(){
      this.outbox = new WebSocket('ws://'+ location.host + "/ws/receive");
    };

    outbox.onclose = function(){
      this.outbox = new WebSocket('ws://'+ location.host + "/ws/send");
    };

    // 为发言按钮绑定点击事件，当用户输入了发言内容，点击发言按钮
    // 我们使用 jQuery 获取到发言内容和用户名
    // 以 JSON 字符串的形式发送给后台服务器
    $("#message-form button").on("click", function(event) {
      text = $('#message-form input').val();
      username = $('#username').text();
      outbox.send(JSON.stringify({username: username, text: text}));
      $('#message-form input').val('');
    });

    // 为 inbox 绑定 onmessage 回调函数
    // 当服务器有消息传递过来，解析消息
    // 组合成 username: message 的形式添加到消息展示框中
    inbox.onmessage = function(message) {
      console.log(message);
      var data = JSON.parse(message.data);
      $('#message-box').append('<p><b>'+data.username+'</b>: '+data.text+'</p>');
    };

  </script>
{% endblock %}
